name: Trigger Quote Bot

on:
  schedule:
    # Run 10 minutes before every hour from 6 AM–9 PM IST
    # IST = UTC +5:30 → Wake at 5:20–20:20 UTC
    - cron: "20 5-20 * * *"

  workflow_dispatch:

jobs:
  call-render:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:

      # 1. Wake Render instance with retry
      - name: Wake Render (retry up to 5 times)
        run: |
          for i in {1..5}; do
            echo "Waking Render (attempt $i)..."
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://quebot-lg0y.onrender.com/")
            if [ "$STATUS" = "200" ]; then
              echo "Render awake!"
              break
            fi
            echo "Failed (HTTP $STATUS). Retrying in 5 seconds..."
            sleep 5
          done

      # 2. Wait for cold start to finish
      - name: Wait for Render cold start (2 minutes)
        run: |
          echo "Waiting 120 seconds for Render to warm up..."
          sleep 120

      # 3. Call /run endpoint ONCE ONLY (NO RETRIES → avoids duplicate tweets)
      - name: Call /run endpoint (one-time execution)
        run: |
          echo "Triggering tweet..."
          curl -s "https://quebot-lg0y.onrender.com/run"
